# Agent Journal – 2025-11-23

Daily log of agent experiments, bug investigations, and operational incidents.

---

### 2025-11-23-1552 – Added primitive skill decomposition scaffolding

- **Owner**: Codex (GPT-5 via Codex CLI)
- **Agents affected**: SkillDecomposer, TaskOrchestrator, primitive catalog
- **Git commit(s)**: Based on f59554c118f513c42b3369581dd57d3850a43708
- **Context**: Implemented the primitive breakdown plan so symbolic actions can be turned into executable xArm primitives with validated schemas and targeted Gemini prompts. Needed reusable primitive docs, plan dataclasses, world-state surface from the orchestrator, and initial caching/validation hooks.
- **Actions**:
  - Added `config/primitive_descriptions.md` documenting `move_to_pose`, `move_to_pose_with_preparation`, `plan_push_pull`, gripper, wrist twist, and retraction primitives aligned to `xarm_curobo_interface.py`.
  - Created `src/planning/skill_plan_types.py` with `PrimitiveCall`, `SkillPlan`, diagnostics, a primitive library with validators, and registry hashing for cache keys.
  - Implemented `src/planning/skill_decomposer.py` to pull orchestrator state, detect staleness, build Gemini prompts from the primitive catalog, parse JSON, validate against the primitive library, and attach interaction-point warnings.
  - Exposed `TaskOrchestrator.get_world_state_snapshot()` for consumers needing registry + snapshot index + robot context; updated planning package exports accordingly.
  - Added smoke tests for the primitive schema/deserialization and deterministic registry hashing (`python -m pytest test_skill_plan_types.py -q`).
- **Result**: We now have a documented primitive catalog, typed plan schema, and an LLM-driven decomposer that vets primitive calls before execution, with world-state context and caching hooks available for planner integration.
- **Next steps**: Wire the decomposer into the execution pipeline and add end-to-end tests that exercise Gemini responses against the primitive validators.
- **References**: `config/primitive_descriptions.md`; `src/planning/skill_plan_types.py`; `src/planning/skill_decomposer.py`; `src/planning/task_orchestrator.py`; `test_skill_plan_types.py`

### 2025-11-23-1619–1701 – Gemini ER alignment + primitive translation refactor

- **Owner**: Codex (GPT-5.1 via Cursor)
- **Agents affected**: SkillDecomposer, PrimitiveExecutor, PrimitiveCall schema, prompts/docs
- **Git commit(s)**: Based on f59554c118f513c42b3369581dd57d3850a43708
- **Context**: Brought the decomposer in line with Gemini Robotics-ER 1.5, added image-grounded affordance enrichment, and reworked primitive translation to live in the executor with structured outputs and shared snapshot loading.
- **Actions**:
  - Defaulted to `gemini-robotics-er-1.5-preview`, attached freshest RGB snapshots, added enrichment for missing affordances, and documented helper-parameter expectations in prompts/docs.
  - Introduced/then replaced a translator layer by moving helper-parameter back-projection into `PrimitiveExecutor`, dropping `llm_parameters`, and validating via the primitive library; shared snapshot loader added.
  - Updated schemas/docs (`config/skill_decomposer_prompts.yaml`, `config/primitive_descriptions.md`, `docs/primitive_task_breakdown_plan.md`) and refreshed regression tests (skill plan types, executor translation).
- **Result**: Plans stay image-grounded until executor translation using shared depth/intrinsics; structured outputs keep LLM responses well-formed; affordance enrichment aligns to the Robotics-ER demo.
- **References**: `src/primitives/skill_decomposer.py`; `src/primitives/primitive_executor.py`; `src/primitives/skill_plan_types.py`; `config/skill_decomposer_prompts.yaml`; `config/primitive_descriptions.md`; `docs/primitive_task_breakdown_plan.md`; `test_skill_plan_types.py`; `test_primitive_executor.py`

### 2025-11-23-1750–1833 – Primitive executor + pick pipeline hardening

- **Owner**: Codex (GPT-5 via Codex CLI)
- **Agents affected**: SkillDecomposer, PrimitiveExecutor, SkillPlan types, pick tests/artifacts, run_cached_plan
- **Git commit(s)**: Based on f59554c118f513c42b3369581dd57d3850a43708
- **Context**: Stabilized executor serialization and default execution, grounded pick tests in fixture assets, split translation vs. LLM coverage, cleaned API gating, and relocated decomposition modules under `primitives/`.
- **Actions**:
  - Added JSON-safe result normalization and defaulted `execute=True` for motion primitives in `PrimitiveExecutor`; regression test for JointState serialization.
  - Retargeted pick tests to `black_folded_fabric/towel`, split translation vs. live-LLM suites, clarified docstrings, separated artifacts (`tests/artifacts/translation_pick/`, `tests/artifacts/llm_pick/`), and recorded translated plans from the needs_api run.
  - Accepted `GEMINI_API_LEY` for API-gated tests; needs_api writes raw + translated LLM plans.
  - Moved `skill_decomposer.py`, `skill_plan_types.py`, `primitive_executor.py` into `src/primitives/` with re-exporting `__init__.py`; updated imports in scripts/tests and docs path reference.
- **Result**: Executor output is JSON-safe and executes motions by default; pick regressions are asset-grounded with clear artifacts; primitives/decomposition code lives under a dedicated package.
- **References**: `src/primitives/`; `scripts/run_cached_plan.py`; `tests/test_pick_translation_to_xarm.py`; `tests/test_pick_decomposition_llm.py`; `tests/artifacts/translation_pick/`; `tests/artifacts/llm_pick/`; `test_skill_plan_types.py`; `test_primitive_executor.py`; `docs/primitive_task_breakdown_plan.md`

### 2025-11-23-1839 – Tests + replay command

- **Owner**: Codex (GPT-5 via Codex CLI)
- **Tests run**: `env UV_CACHE_DIR=.uv-cache uv run python -m pytest -q` (needs_api skipped without key); earlier targeted: `test_primitive_executor.py::test_execute_plan_serializes_joint_state_results` and pick translation/LLM suites.
- **Replay command**: `uv run python scripts/run_cached_plan.py --plan tests/artifacts/translation_pick/pick_plan_prepare_plan.json --world tests/assets/continuous_pick_fixture --dry-run` (drop `--dry-run` and set `--robot-ip` to execute; for live LLM output, swap plan to `tests/artifacts/llm_pick/pick_plan_llm_translated.json`).

### 2025-11-23-1845 – Primitives package relocated

- **Owner**: Codex (GPT-5 via Codex CLI)
- **Agents affected**: SkillDecomposer, PrimitiveExecutor, SkillPlan types, run_cached_plan, tests
- **Context**: Needed decomposition-related modules under a top-level `src/primitives` package instead of `src/planning/primitives`.
- **Actions**:
  - Moved `skill_decomposer.py`, `primitive_executor.py`, `skill_plan_types.py`, and the primitives `__init__.py` to `src/primitives/`; updated imports across scripts/tests/docs and removed primitives re-export from `planning/__init__.py`.
  - Updated doc path references and test loaders accordingly.
  - Ran full pytest (needs_api still skipped without key).
- **Result**: Primitives/decomposition live in `src/primitives/` with all tests passing post-move.
- **Tests**: `env UV_CACHE_DIR=.uv-cache uv run python -m pytest -q`
- **References**: `src/primitives/`; `scripts/run_cached_plan.py`; `tests/test_pick_translation_to_xarm.py`; `tests/test_pick_decomposition_llm.py`; `test_skill_plan_types.py`; `test_primitive_executor.py`; `docs/primitive_task_breakdown_plan.md`
