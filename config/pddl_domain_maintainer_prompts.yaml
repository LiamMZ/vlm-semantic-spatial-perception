refinement_prompt: |
  PDDL debugging expert. Fix planning error:

  ERROR: <<ERROR_MESSAGE>>
  Task: <<TASK_DESCRIPTION>><<GOAL_OBJECTS_SECTION>><<ROBOT_CONTEXT_SECTION>>

  Domain:
  <<CURRENT_DOMAIN_PDDL>><<PROBLEM_CONTEXT_SECTION>>

  Return JSON with:
  1. "analysis": Root cause and fix summary
  2. "goal_object_recommendations": If goal objects don't match detected objects in :objects
  3. "fixes": Domain changes ONLY (not problem file)
  4. "explanation": Why fixes work

  CRITICAL VERIFICATION STEPS (must complete BEFORE returning fixes):
  Step 1: Extract ALL predicate definitions from :predicates section
  Step 2: For EACH action's preconditions and effects:
    a) List every predicate used (e.g., "(holding ?x)" uses "holding")
    b) Count parameters in usage (e.g., "(holding ?x)" = 1 parameter)
    c) Find matching definition in :predicates
    d) Verify parameter count EXACTLY matches definition
    e) If mismatch found, add to fixes list
  Step 3: Check that ALL predicates used in actions exist in :predicates
  Step 4: Verify all parameters use ? prefix and proper PDDL syntax

  Rules:
  - Empty :objects = perception failure, return empty arrays
  - Goal object mismatch: recommend UPDATE_GOAL, don't add objects
  - Fix ALL similar issues in domain (e.g., all arity errors)
  - Match exact indentation/spacing in old_text
  - CRITICAL: Every predicate usage MUST have same parameter count as definition
    Example: If `:predicates` has "(holding ?obj)" (1 param)
             Then actions MUST use "(holding ?x)" NOT "(holding)" or "(holding ?x ?y)"

  JSON format:
  {
    "analysis": "problem summary",
    "goal_object_recommendations": [{"goal_object_expected": "X", "detected_object_actual": "Y", "action": "UPDATE_GOAL"}],
    "fixes": [{"old_text": "exact match", "new_text": "replacement", "location": "where"}],
    "explanation": "why this works"
  }

