refinement_prompt: |
  PDDL debugging expert. Fix planning error with focus on valid action chains:

  ERROR: <<ERROR_MESSAGE>>
  Task: <<TASK_DESCRIPTION>><<GOAL_OBJECTS_SECTION>><<ROBOT_CONTEXT_SECTION>>

  Domain:
  <<CURRENT_DOMAIN_PDDL>><<PROBLEM_CONTEXT_SECTION>>

  Return JSON with:
  1. "analysis": Root cause and fix summary
  2. "goal_object_recommendations": If goal objects don't match detected objects in :objects
  3. "fixes": Domain changes ONLY (not problem file)
  4. "explanation": Why fixes work

  CRITICAL: Ensure actions chain correctly - effects must match next action's preconditions.

  VERIFICATION (complete BEFORE returning fixes):
  a) **Arity**: Every predicate usage must match parameter count in definition
     - Example: "(holding ?obj)" in :predicates → use "(holding ?x)" in actions (both 1 param)
  b) **ACTION CHAIN VALIDATION** (MOST IMPORTANT):
     - For EACH pair of actions that execute in sequence:
       * List effects produced by first action
       * List preconditions needed by second action
       * VERIFY effects satisfy preconditions
     - Common chains: pick→place, open→access, pour→empty
     - Example CORRECT: pick effect "(holding ?obj)" → place precondition "(holding ?obj)" ✓
     - Example BROKEN: pick effect "(holding ?obj)" → place precondition "(grasped ?obj)" ✗
  c) **Achievability**: Each action's preconditions must be reachable via:
     - Initial state (from :init), OR other action effects, OR perception predicates
  d) **Goals**: Each goal must be achievable by at least one action's effects

  Rules:
  - Empty :objects = perception failure, return empty arrays
  - Goal object mismatch: recommend UPDATE_GOAL, don't add objects
  - Fix ALL similar issues (e.g., all arity errors, all broken chains)
  - Match exact indentation/spacing in old_text
  - Ensure action chains work: effects must produce what next action needs

  JSON format:
  {
    "analysis": "problem summary",
    "goal_object_recommendations": [{"goal_object_expected": "X", "detected_object_actual": "Y", "action": "UPDATE_GOAL"}],
    "fixes": [{"old_text": "exact match", "new_text": "replacement", "location": "where"}],
    "explanation": "why this works"
  }

